<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>MML to WAV</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
<body>
<script type="module">
    // worker
    const worker = new Worker('./picosakura-worker.js', { type: "module" });
    worker.addEventListener('message', (event) => {
        console.log("Data from worker received: ", event);
        const btnSave = document.getElementById('btnSave');
        const msg = document.getElementById('msg');
        const downloadLink = document.getElementById('download');
        if (event.data.type === 'loaded') {
            console.log('worker loaded');
            btnSave.disabled = false;
            msg.innerHTML = '';
            return;
        }
        if (event.data.type === 'error') {
            msg.innerHTML = '[WORKER_ERROR]' + tohtml(event.data);
        }
        if (event.data.type === 'makeWav:ok') {
            const {wav, log} = event.data.data;
            const dataview = new DataView(wav.buffer);
            const audioBlob = new Blob([dataview], { type: 'audio/wav' });
            let url = window.URL.createObjectURL(audioBlob);
            if (url === null) {
                downloadLink.href = '#';
                return;
            }
            btnSave.disabled = false;
            msg.innerHTML = '';
            // make download link
            downloadLink.href = url;
            downloadLink.download = 'audio.wav';
            downloadLink.click();
        }
    }, false);
    //
    function tohtml(s) {
        s = s.replace(/&/g, '&amp;')
        s = s.replace(/</g, '&lt;')
        s = s.replace(/>/g, '&gt;')
        s = s.replace(/\n/g, '<br>\n')
        return s
    }

    function makeWav(mml) {
        try {
            worker.postMessage({type: 'makeWav', mml: mml});
        } catch (err) {
            console.error(err);
            document.getElementById('msg').innerHTML = '[SYSTEM_ERROR]' + tohtml(err.toString())
        }
    }
    // load
    async function loadBinary(url) {
        const resp = await fetch(url);
        return await resp.arrayBuffer();
    }
    // button
    const downloadLink = document.getElementById('download');
    btnSave.onclick = async () => {
        const btnSave = document.getElementById('btnSave');
        const msg = document.getElementById('msg');
        btnSave.disabled = true;
        // save mml
        const mml = document.getElementById('mml').value;
        localStorage.setItem('picosakura_txt', mml); // save
        msg.innerHTML = 'Now converting...<img src="./loader.gif">';
        makeWav(mml);
    };
    // load
    window.addEventListener('load', () => {
        // load from localStorage
        const txt = localStorage.getItem('picosakura_txt');
        if (txt) {
            const mml = document.getElementById('mml');
            mml.value = txt;
        }
    });
    </script>
    <div>
        <h1>Picosakura to WAV</h1>
        <div>MML:<br><textarea id="mml" rows="10" cols="80">o4v120 cdefgfed</textarea></div>
        <div><button id="btnSave" disabled="disabled">Download to WAV</button></div>
        <div id="msg">Now loading...</div>
        <a id="download"></a>
    </div>
    <div>&nbsp;</div>
    <div style="padding: 12px; border: 1px solid silver; background-color: #f0f0f0;">
        <div style="font-size: 0.8em;">
            テキストボックスにMMLを記入し、上記の「Download to WAV」ボタンを押すと、WAVファイルをダウンロードできます。<br>
            ブラウザ上でWAVのレンダリングするので書き出しには時間がかかります。
        </div>
    </div>
</body>
</html>
